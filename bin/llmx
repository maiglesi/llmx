#!/usr/bin/env bash
# LLMX - LLM Exchange Protocol CLI
# https://github.com/maiglesi/llmx
#
# A token-efficient protocol for inter-LLM communication

set -e

VERSION="1.0.0"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Configuration (can be overridden in ~/.llmxrc)
LLMX_LOG_DIR="${LLMX_LOG_DIR:-$HOME/.llmx}"
LLMX_LOG_FILE="${LLMX_LOG_DIR}/messages.log"
LLMX_SEQ_FILE="${LLMX_LOG_DIR}/sequence"
LLMX_DEFAULT_TARGET="${LLMX_DEFAULT_TARGET:-}"

# LLM Commands (override in ~/.llmxrc)
LLMX_CMD_GEMINI="${LLMX_CMD_GEMINI:-gemini}"
LLMX_CMD_CODEX="${LLMX_CMD_CODEX:-codex exec}"
LLMX_CMD_GPT4="${LLMX_CMD_GPT4:-}"
LLMX_CMD_OLLAMA="${LLMX_CMD_OLLAMA:-ollama run}"

# Load user config
[[ -f "$HOME/.llmxrc" ]] && source "$HOME/.llmxrc"

# Colors (disable with NO_COLOR=1)
if [[ -z "${NO_COLOR:-}" ]]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    CYAN='\033[0;36m'
    MAGENTA='\033[0;35m'
    BOLD='\033[1m'
    NC='\033[0m'
else
    RED='' GREEN='' YELLOW='' BLUE='' CYAN='' MAGENTA='' BOLD='' NC=''
fi

# Ensure directories exist
init_dirs() {
    mkdir -p "$LLMX_LOG_DIR"
    touch "$LLMX_LOG_FILE"
    [[ -f "$LLMX_SEQ_FILE" ]] || echo "0" > "$LLMX_SEQ_FILE"
}

# Get next sequence number
get_seq() {
    local seq
    seq=$(cat "$LLMX_SEQ_FILE")
    echo $((seq + 1)) > "$LLMX_SEQ_FILE"
    echo $((seq + 1))
}

# Log message
log_msg() {
    local from="$1" to="$2" msg="$3"
    echo "[$(date -u +"%Y-%m-%dT%H:%M:%SZ")] $from -> $to: ${msg:0:200}..." >> "$LLMX_LOG_FILE"
}

# Check if command exists
cmd_exists() {
    command -v "$1" &>/dev/null
}

# Get LLM command
get_llm_cmd() {
    local target="$1"
    case "$target" in
        gemini)
            echo "$LLMX_CMD_GEMINI"
            ;;
        codex)
            echo "$LLMX_CMD_CODEX"
            ;;
        gpt4|openai)
            echo "$LLMX_CMD_GPT4"
            ;;
        ollama|llama)
            echo "$LLMX_CMD_OLLAMA"
            ;;
        *)
            echo ""
            ;;
    esac
}

# Send to specific LLM
send_to_llm() {
    local target="$1"
    local msg="$2"
    local seq
    seq=$(get_seq)

    local full_msg="HEADER:{f:Claude,t:$target,s:$seq}
$msg"

    local cmd
    cmd=$(get_llm_cmd "$target")

    if [[ -z "$cmd" ]]; then
        echo -e "${RED}Error: No command configured for target '$target'${NC}" >&2
        echo "Configure in ~/.llmxrc: LLMX_CMD_${target^^}=\"command\"" >&2
        return 1
    fi

    local base_cmd="${cmd%% *}"
    if ! cmd_exists "$base_cmd"; then
        echo -e "${RED}Error: Command '$base_cmd' not found${NC}" >&2
        echo "Install it or configure alternative in ~/.llmxrc" >&2
        return 1
    fi

    echo -e "${BLUE}[Claude â†’ ${target^}]${NC} seq:$seq" >&2
    log_msg "Claude" "$target" "$msg"

    case "$target" in
        gemini)
            echo "$full_msg" | $cmd 2>/dev/null
            ;;
        codex)
            $cmd "$full_msg" 2>/dev/null | tail -n +20
            ;;
        *)
            echo "$full_msg" | $cmd 2>/dev/null
            ;;
    esac
}

# Usage
usage() {
    cat << EOF
${CYAN}${BOLD}LLMX${NC} - LLM Exchange Protocol CLI v${VERSION}

${BOLD}Usage:${NC}
  llmx <command> [options]

${BOLD}Commands:${NC}
  send <target> <message>     Send raw LLMX message to target LLM
  ask <target> <question>     Ask a question (auto-wrapped in LLMX)
  delegate <target> <task>    Delegate task with tracking
  parallel <msg1> <msg2>      Send to Gemini and Codex in parallel
  broadcast <message>         Send to all configured LLMs
  status                      Show recent LLMX communications
  log                         Show full message log
  reset                       Reset sequence counter
  version                     Show version

${BOLD}Targets:${NC}
  gemini    Google Gemini
  codex     OpenAI Codex CLI
  gpt4      OpenAI GPT-4
  ollama    Local Ollama/Llama

${BOLD}Options:${NC}
  -i, --issue <ID>    Associate with issue/ticket
  -p, --priority <N>  Set priority (1-5, default: 2)
  -h, --help          Show this help

${BOLD}Examples:${NC}
  llmx send gemini 'REQ:{o:"review code",pr:2}'
  llmx ask codex "implement user authentication"
  llmx delegate gemini "create components" --issue PROJ-123
  llmx parallel "review frontend" "review backend"

${BOLD}Configuration:${NC}
  Create ~/.llmxrc to customize:
    LLMX_CMD_GEMINI="gemini"
    LLMX_CMD_CODEX="codex exec"
    LLMX_DEFAULT_TARGET="gemini"

${BOLD}More info:${NC}
  https://github.com/maiglesi/llmx
EOF
}

# Commands
cmd_send() {
    local target="$1"
    shift
    local msg="$*"

    if [[ -z "$target" ]]; then
        target="${LLMX_DEFAULT_TARGET:-}"
        if [[ -z "$target" ]]; then
            echo -e "${RED}Error: target required${NC}" >&2
            echo "Usage: llmx send <target> <message>" >&2
            return 1
        fi
    fi

    if [[ -z "$msg" ]]; then
        echo -e "${RED}Error: message required${NC}" >&2
        return 1
    fi

    send_to_llm "$target" "$msg"
}

cmd_ask() {
    local target="$1"
    shift
    local question="$*"

    if [[ -z "$target" ]] || [[ -z "$question" ]]; then
        echo -e "${RED}Error: target and question required${NC}" >&2
        echo "Usage: llmx ask <target> <question>" >&2
        return 1
    fi

    local msg="CTX:{p:llmx,st:{proto:\"LLMX1.0\"}}
REQ:{o:\"$question\",pr:3}"

    send_to_llm "$target" "$msg"
}

cmd_delegate() {
    local target="$1"
    shift

    local task="" issue="" priority="2"

    while [[ $# -gt 0 ]]; do
        case "$1" in
            -i|--issue)
                issue="$2"
                shift 2
                ;;
            -p|--priority)
                priority="$2"
                shift 2
                ;;
            *)
                task="$task $1"
                shift
                ;;
        esac
    done
    task="${task# }"

    if [[ -z "$target" ]] || [[ -z "$task" ]]; then
        echo -e "${RED}Error: target and task required${NC}" >&2
        echo "Usage: llmx delegate <target> <task> [--issue ID] [--priority N]" >&2
        return 1
    fi

    local ctx="CTX:{p:llmx"
    [[ -n "$issue" ]] && ctx="$ctx,issue:\"$issue\""
    ctx="$ctx}"

    local msg="$ctx
REQ:{o:\"$task\",pr:$priority}
PLAN:[(i:1,t:\"analyze\",s:P),(i:2,t:\"implement\",s:P),(i:3,t:\"verify\",s:P)]"

    echo -e "${CYAN}Delegating to $target:${NC} $task" >&2
    [[ -n "$issue" ]] && echo -e "  Issue: $issue" >&2
    echo >&2

    send_to_llm "$target" "$msg"
}

cmd_parallel() {
    local msg1="$1"
    local msg2="$2"

    if [[ -z "$msg1" ]] || [[ -z "$msg2" ]]; then
        echo -e "${RED}Error: two messages required${NC}" >&2
        echo "Usage: llmx parallel 'gemini task' 'codex task'" >&2
        return 1
    fi

    local batch_id="B$(date +%s)"

    echo -e "${YELLOW}Parallel execution (batch: $batch_id)${NC}" >&2
    echo >&2

    local gemini_out codex_out
    gemini_out=$(mktemp)
    codex_out=$(mktemp)

    (
        local seq
        seq=$(get_seq)
        local full_msg="HEADER:{f:Claude,t:Gemini,s:$seq,b:$batch_id}
CTX:{p:llmx}
REQ:{o:\"$msg1\",pr:2}"
        echo "$full_msg" | $LLMX_CMD_GEMINI 2>/dev/null
    ) > "$gemini_out" &
    local gpid=$!

    (
        local seq
        seq=$(get_seq)
        local full_msg="HEADER:{f:Claude,t:Codex,s:$seq,b:$batch_id}
CTX:{p:llmx}
REQ:{o:\"$msg2\",pr:2}"
        $LLMX_CMD_CODEX "$full_msg" 2>/dev/null | tail -n +20
    ) > "$codex_out" &
    local cpid=$!

    echo -n "Working" >&2
    while kill -0 $gpid 2>/dev/null || kill -0 $cpid 2>/dev/null; do
        echo -n "." >&2
        sleep 1
    done
    echo " Done!" >&2
    echo >&2

    echo -e "${BLUE}=== Gemini ===${NC}"
    cat "$gemini_out"
    echo
    echo -e "${GREEN}=== Codex ===${NC}"
    cat "$codex_out"

    rm -f "$gemini_out" "$codex_out"

    log_msg "Claude" "Gemini" "$msg1 (batch:$batch_id)"
    log_msg "Claude" "Codex" "$msg2 (batch:$batch_id)"
}

cmd_broadcast() {
    local msg="$*"

    if [[ -z "$msg" ]]; then
        echo -e "${RED}Error: message required${NC}" >&2
        return 1
    fi

    echo -e "${YELLOW}Broadcasting to all LLMs...${NC}" >&2

    for target in gemini codex; do
        local cmd
        cmd=$(get_llm_cmd "$target")
        if [[ -n "$cmd" ]] && cmd_exists "${cmd%% *}"; then
            echo -e "\n${CYAN}=== ${target^} ===${NC}"
            send_to_llm "$target" "$msg"
        fi
    done
}

cmd_status() {
    echo -e "${CYAN}${BOLD}LLMX Communication Status${NC}"
    echo
    echo -e "${BOLD}Sequence:${NC} $(cat "$LLMX_SEQ_FILE" 2>/dev/null || echo 0)"
    echo -e "${BOLD}Log file:${NC} $LLMX_LOG_FILE"
    echo
    echo -e "${BOLD}Recent messages:${NC}"
    if [[ -f "$LLMX_LOG_FILE" ]]; then
        tail -10 "$LLMX_LOG_FILE" | while read -r line; do
            echo "  $line"
        done
    else
        echo "  (no messages yet)"
    fi
}

cmd_log() {
    if [[ -f "$LLMX_LOG_FILE" ]]; then
        cat "$LLMX_LOG_FILE"
    else
        echo "No messages logged yet."
    fi
}

cmd_reset() {
    echo "0" > "$LLMX_SEQ_FILE"
    echo -e "${GREEN}Sequence counter reset.${NC}"
}

cmd_version() {
    echo "LLMX v${VERSION}"
}

# Main
main() {
    init_dirs

    case "${1:-}" in
        send)
            shift
            cmd_send "$@"
            ;;
        ask)
            shift
            cmd_ask "$@"
            ;;
        delegate)
            shift
            cmd_delegate "$@"
            ;;
        parallel)
            shift
            cmd_parallel "$@"
            ;;
        broadcast)
            shift
            cmd_broadcast "$@"
            ;;
        status)
            cmd_status
            ;;
        log)
            cmd_log
            ;;
        reset)
            cmd_reset
            ;;
        version|--version|-v)
            cmd_version
            ;;
        help|--help|-h|"")
            usage
            ;;
        *)
            echo -e "${RED}Unknown command: $1${NC}" >&2
            echo "Run 'llmx --help' for usage" >&2
            exit 1
            ;;
    esac
}

main "$@"
